<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑学霸-悟空</title>
    <style>
        /* 基础样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1d1f27;
            background-size: cover;
            background-position: center;
            color: #fff;
            overflow: auto;
        }

        .summary {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin: 0 auto;
        }
        .summary h2 {
            text-align: center;
        }
        .wrong-questions {
            margin-top: 20px;
        }
        .wrong-questions li {
            margin-bottom: 15px;
            list-style-type: none;
        }
        .wrong-questions li p {
            margin: 5px 0;
        }
        .highlight {
            color: red;
            font-weight: bold;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        .actions button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #game-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
            padding: 10px;
            background-size: cover;
        }

        /* 血条容器 */
        .health-bar-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 10px;
        }

        /* 血条样式 */
        .health-bar {
            width: 300px;
            height: 60px;
            position: relative;
        }

        .hp-bar {
            width: 100%;
            height: 50%;
            background-color: red;
        }

        .character-name {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: white;
            text-align: center;
        }

        /* 角色样式 */
        .characters {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            position: relative;
        }

        .characters img {
            position: relative;
            width: 150px;
            margin: 0 100px;
        }

        /* 粒子特效 */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            animation: particle-animation 1s ease-out forwards;
            pointer-events: none; /* 不影响用户操作 */
            z-index: 1000;
        }

        @keyframes particle-animation {
            0% {
                opacity: 1;
                transform: scale(1) translate(0, 0);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translate(calc(var(--dx, 0) * 100px), calc(var(--dy, 0) * 100px));
            }
        }

        /* 过渡效果 */
        #level-up {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: gold;
            text-shadow: 2px 2px 8px black;
            display: none;
        }

        /* 问题和回答区容器 */
        .question-container {
            display: flex;
            flex-direction: column;
            justify-content: center; /* 垂直居中 */
            align-items: center; /* 水平居中 */
            margin: 10px auto; /* 顶部和底部的间距 */
            padding: 10px;
            max-width: 80%; /* 防止太宽 */
            text-align: center;
            /* border: 1px solid #ccc;
            border-radius: 8px; */
            /* background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */
        }

        /* 问题样式 */
        .question {
            font-size: 20px;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 1px 1px 2px black;
        }

        .question img {
            height: 80px;
            display: block;
        }

        /* 答案输入样式 */
        .input-answer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px; /* 输入框和按钮的间距 */
        }

        .input-answer input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
            width: 250px; /* 更宽一些的输入框 */
        }

        .input-answer button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .input-answer button:hover {
            background-color: #45a049;
        }

        /* 答案选项区域 */
        .options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* 允许多行选项 */
            gap: 15px; /* 选项之间的间距 */
            color: #333333;
        }

        .option {
            padding: 10px 20px;
            background-color: #ddd;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .option:hover {
            border-color: #007BFF;
            background-color: #bbb;
        }

        #active-skill-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top:10px;
        }

        .active-skill-button {
            padding:20px 20px;
            background-size: cover;
        }

        #passive-skill-container {
            display: flex;
            width: 100%;
            height: 50%;
        }

        .passive-skill-button {
            padding: 15px 15px;
            background-size: cover;
        }

        /* 角色的攻击和受伤动画 */
        .attack-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: red;
            font-weight: bold;
            opacity: 1;
            animation: attack-animation 1s forwards;
            pointer-events: none;
        }

        @keyframes attack-animation {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        /* 受伤动画 */
        .damage-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: blue;
            font-weight: bold;
            opacity: 1;
            animation: damage-animation 1s forwards;
            pointer-events: none;
        }

        @keyframes damage-animation {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
        }

        /* 攻击动作动画 */
        @keyframes attack {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(300px); /* 向目标方向移动 */
            }
            75% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(0);
            }
        }

        /* 被攻击动作动画 */
        @keyframes hurt {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-100px); /* 向后移动 */
            }
            75% {
                transform: translateX(100px); /* 向前弹一下 */
            }
            100% {
                transform: translateX(0);
            }
        }

        /* 添加动画时的样式 */
        .attack {
            z-index: 100;
            animation: attack 0.5s ease-in-out;
        }

        .hurt {
            animation: hurt 0.5s ease-in-out;
        }

        @keyframes boss-attack {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(-300px); /* 向左移动，靠近玩家 */
            }
            75% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(0); /* 返回原位 */
            }
        }

        /* 被攻击动作动画 */
        @keyframes boss-hurt {
            0% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px); /* 向后移动 */
            }
            75% {
                transform: translateX(-100px); /* 向前弹一下 */
            }
            100% {
                transform: translateX(0);
            }
        }

        .boss-attack {
            animation: boss-attack 0.5s ease-in-out;
        }

        .boss-hurt {
            animation: boss-hurt 0.5s ease-in-out;
        }

        button {
            text-shadow: 1px 1px 2px black;
            color: white;
        }

        /* 设置整体样式 */
        #level-select {
            display: flex;
            flex-direction: column;
            /* max-height: 100vh; 避免超出视口 */
        }

        /* 固定顶部的关卡选择标题 */
        #level-header {
            position: sticky; /* 或使用 fixed */
            top: 0; /* 紧贴页面顶部 */
            background-color: #333; /* 背景色（避免内容滚动时透明） */
            color: #fff;
            padding: 10px;
            text-align: center;
            z-index: 10; /* 确保固定区域不被覆盖 */
        }

        #level-buttons-container {
            max-height: 80vh; /* 设置最大高度为视口的 80% */
            flex-grow: 1; /* 占用剩余空间 */
            overflow-y: auto; /* 超出高度时启用垂直滚动 */
            border: 1px solid #ccc; /* 添加一个边框以区分界限 */
            border-radius: 10px; /* 边角圆滑 */
            padding: 10px; /* 添加适当的内边距 */
            background-color: rgba(0, 0, 0, 0.5); /* 半透明背景 */
        }

        /* 弹层的全屏黑色背景 */
        #skill-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* 技能内容居中显示 */
        .skill-content {
            text-align: center;
            color: white;
            animation: fadeIn 0.5s ease;
        }

        .skill-content img {
            width: 150px;
            height: 150px;
            margin-bottom: 20px;
        }

        .skill-content p {
            font-size: 18px;
        }

        /* 渐入动画 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
    <script src="questions.js"></script>
</head>
<body>
    <div id="summary-container" class="summary">
        <h2>闯关总结</h2>
        <p id="attempts">累计答题次数: </p>
        <p id="accuracy">正确率: </p>
        <div id="wrong-section">
            <p>以下是你做错的题目及详细反馈：</p>
            <ul id="wrong-list"></ul>
        </div>
        <div class="actions">
            <button id="return-button">返回</button>
        </div>
    </div>
    <div id="skill-overlay" style="display: none;">
        <div class="skill-content">
            <img id="skill-icon" src="" alt="Skill Icon">
            <p id="skill-description"></p>
        </div>
    </div>
    <div id="game-container" style="display: none;">
        <!-- 血条 -->
        <div class="health-bar-container">
            <div class="health-bar" id="player-bar-container">
                <div id="player-hp" class="hp-bar"></div>
                <div class="character-name" id="player-name">Player</div>
                <div id="passive-skill-container"></div> 
                <audio id="player-attack-sound" src="sounds/stick-attack.mp3" preload="auto"></audio>
                <audio id="player-hurt-sound" src="sounds/hurt.mp3" preload="auto"></audio>
            </div>
            <div class="health-bar" id="boss-bar-container">
                <div id="boss-hp" class="hp-bar"></div>
                <div class="character-name" id="boss-name">Boss</div>
                <audio id="boss-attack-sound" src="sounds/monster-attack.mp3" preload="auto"></audio>
                <audio id="boss-hurt-sound" src="sounds/hurt.mp3" preload="auto"></audio>
            </div>
        </div>
        <!-- 角色 -->
        <div class="characters">
            <img id="player-image" src="images/player.gif" alt="Player">
            <img id="boss-image" src="images/level1_boss.png" alt="Boss">
        </div>
        <div class="question-container">
            <div class="question" id="question">这里显示问题</div>
            <!-- 选择题区域 -->
            <div class="options" id="options" style="display: none;"></div>
            <!-- 自由输入区域 -->
            <div class="input-answer" id="input-answer" style="display: none;">
                <input type="text" id="answer-input" placeholder="输入答案...">
                <button onclick="submitAnswer()">提交</button>
            </div>
            <div id="active-skill-container"></div> 
        </div>
    </div>
    <div id="level-up">获胜！</div>
    <!-- 关卡选择界面 -->
    <div id="level-select" style="text-align: center;">
        <!-- <h2>选择关卡</h2> -->
        <h2 id="level-header">选择关卡</h2>
        <div id="level-buttons-container" style="max-height: 60vh; overflow-y: auto; border: 1px solid #ccc; border-radius: 10px; padding: 10px;"></div>
            <div id="level-buttons" style="display: flex; justify-content: center; gap: 20px; flex-direction: column; flex-wrap: wrap;">
                <!-- 按钮将动态生成 -->
            </div>
        </div>
    </div>
    <script>
        // 全局变量
        let level = 1;
        let currentQuestion = null;
        let playerHP = calPlayerHP(level);
        let bossHP = 0;

        // 闯关数据统计
        let totalAttempts = 0; // 累计答题次数
        let correctCount = 0;  // 累计答对次数
        let wrongQuestions = []; // 做错题目记录

        let currentLevelWrongCount = 0; // 当前关卡的错误次数

        function baseDamageFixer (attacker) {
            return {
                damage: attacker.damage,
                crit_rate: attacker.crit_rate,
                crit_multiplier: attacker.crit_multiplier,
            };
        }

        function basedefenseFixer (defender) {
            return {
                crit_immunity: false,
                damage_reduction: 0,
            };
        }

        let player = {
            name: "天命人", 
            image: "images/player.gif",
            image_attack: "images/player.gif",
            hp: calPlayerHP(level),
            damage: 100,
            crit_rate: 0,
            crit_multiplier: 0,
            attack_sound: "sounds/stick-attack.mp3",
            hurt_sound: "sounds/hurt.mp3",
            on_dead: function() {
                return true;
            },
            damageFixers: [
                baseDamageFixer,
            ],
            defenseFixers: [
                basedefenseFixer,
            ],
            skills: {},
        }
        let skills = {
            "life_saving_hair": {
                name: "救命毫毛",
                description: "救命毫毛，濒死时，自行施展，借毫毛将天命人起死复生。",
                icon: "images/life_saving_hair.png",
                passive: true,
                on_dead: () => {
                    if (player.skills["life_saving_hair"] && player.skills["life_saving_hair"].value <= 0) {
                        return true;
                    }
                    player.skills["life_saving_hair"].value--;
                    player.hp = calPlayerHP(level);
                    if (player.skills["life_saving_hair"].value <= 0) {
                        renderSkills(false);
                    }
                    return false;
                },
                event_listener: ["on_dead"],
                value: 1,
            },
            "ironhide": {
                name: "铜头铁臂",
                description: "铜头铁臂，瞬时如金石般坚硬，抵挡物理攻击。",
                icon: "images/ironhide.png",
                passive: false,
                value: 3,
                do: async () =>{
                    if (player.skills["ironhide"] && player.skills["ironhide"].value <= 0) {
                        return;
                    }
                    player.skills["ironhide"].value--;
                    document.getElementById("player-hurt-sound").src = "sounds/ironhide.mp3";
                    await showAttackEffect(false);
                    document.getElementById("player-hurt-sound").src = player.hurt_sound;
                    checkGameStatus();
                    if (player.skills["ironhide"].value <= 0) {
                        renderSkills(false);
                    }
                }
            },
            "crit": {
                name: "聚形散气",
                description: "聚形散气，化作白烟，隐身遁走，寻找机会破隐一击。",
                icon: "images/crit.png",
                passive: true,
                value: 1,
                damageFixer: (attacker, damageAttr) => {
                    return {
                        damage: damageAttr.damage,
                        crit_rate: 100,
                        crit_multiplier: damageAttr.crit_multiplier+100,
                    };
                },
                defenseFixer: (defender, defenseAttr) => {
                    let ri = Math.floor(Math.random()*100);
                    if (ri < 20){
                        return defenseAttr;
                    }
                    return {
                        crit_immunity: false,
                        damage_reduction: 100,
                    };
                },
            }
        }

        let bosses = [
            { 
                name: "黑熊精", 
                image: "images/level1_boss.png", 
                image_attack: "images/level1_boss_attack.png", 
                hp: 50, 
                damage: 100,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg1.webp", 
                attack_sound: "sounds/monster-attack.mp3",
                hurt_sound: "sounds/hurt.mp3",
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [],
                awards: ["crit"]
            },
            { 
                name: "黄风大圣", 
                image: "images/level2_boss.png", 
                image_attack: "images/level2_boss.png", 
                hp: 80, 
                damage: 100,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg2.webp", 
                attack_sound: "sounds/sword-attack.mp3",
                hurt_sound: "sounds/hurt.mp3",
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [
                    basedefenseFixer,
                ],
                awards: ["ironhide"]
            },
            { 
                name: "黄眉老佛", 
                image: "images/level3_boss.png", 
                image_attack: "images/level3_boss.png", 
                hp: 120, 
                damage: 100,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg3.webp", 
                attack_sound: "sounds/stick-attack.mp3",
                hurt_sound: "sounds/hurt.mp3",
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [
                    basedefenseFixer,
                ],
                awards: []
            },
            { 
                name: "百眼魔君", 
                image: "images/level4_boss.png", 
                image_attack: "images/level4_boss.png", 
                hp: 180, 
                damage: 110,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg4.webp", 
                attack_sound: "sounds/magic-attack.mp3",
                hurt_sound: "sounds/hurt.mp3",
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [
                    basedefenseFixer,
                ],
            },
            { 
                name: "夜叉王", 
                image: "images/level5_boss.png", 
                image_attack: "images/level5_boss_attack.png", 
                hp: 220, 
                damage: 120,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg5.webp", 
                attack_sound: "sounds/sword-attack2.mp3",
                hurt_sound: "sounds/hurt.mp3",
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [
                    basedefenseFixer,
                ],
            },
            { 
                name: "大圣残躯", 
                image: "images/level6_boss.png", 
                image_attack: "images/level6_boss.png", 
                hp: 300, 
                damage: 150,
                crit_rate: 0,
                crit_multiplier: 1,
                bg: "images/bg6.webp", 
                attack_sound: "sounds/stick-attack.mp3",
                hurt_sound: "sounds/hurt.mp3",
                awards: ["life_saving_hair"],
                damageFixers: [
                    baseDamageFixer,
                ],
                defenseFixers: [
                    () => {
                        return {
                            crit_immunity: true,
                            damage_reduction: 0,
                        };
                    },
                ],
            },
        ];

        // const questions = [
            // {
            //     question: "2 + 2 等于几？",
            //     img: "",
            //     options: ["3", "4", "5"],
            //     answer: "4",
            //     knowledge: "",
            //     difficulty: 1
            // },
            // {
            //     question: "HTTP 的默认端口号是？",
            //     img: "",
            //     options: [],
            //     answer: "80",
            //     knowledge: "http的默认端口号是80",
            //     difficulty: 2
            // }
        // ];

        // 更新关卡选择界面
        function renderLevelSelect() {
            // 切换到游戏界面
            document.getElementById("level-select").style.display = "flex";
            document.getElementById("summary-container").style.display = "none";
            document.getElementById("game-container").style.display = "none";
            
            const levelButtons = document.getElementById("level-buttons");
            levelButtons.innerHTML = bosses.map((boss, index) => `
                <button onclick="resetGame(${index + 1})" style="padding: 50px 20px; font-size: 18px;background-image: url('${boss.bg}');">
                    关卡 ${index + 1}: ${boss.name}
                </button>
            `).join("");
        }

        function calPlayerHP(level) {
            return 50+level*10
        }

        function updateBossInfo() {
            bossIndex = level - 1;
            const boss = bosses[bossIndex];
            document.getElementById("boss-name").textContent = boss.name;
            // animation.classList.contains("active");
            let bossImg = document.getElementById("boss-image");
            bossImg.src = boss.image;
            document.getElementById("boss-attack-sound").src = boss.attack_sound;
            document.getElementById("boss-hurt-sound").src = boss.hurt_sound;
            
            if (bossImg.classList.contains("boss-hurt")) {
                bossImg.addEventListener('animationend', () => {
                    bossImg.classList.remove("boss-hurt");
                    bossImg.src = boss.image;
                }, { once: true });
            }
            if (bossImg.classList.contains("boss-attack")) {
                bossImg.addEventListener('animationend', () => {
                    bossImg.classList.remove("boss-attack");
                    bossImg.src = boss.image;
                }, { once: true });
            }

            document.getElementById("game-container").style.backgroundImage = `url('${boss.bg}')`;
            bossHP = boss.hp;
            updateHealthBars();
            renderSkills(false);
        }

        function updateHealthBars() {
            bossIndex = level - 1;
            const boss = bosses[bossIndex];
            document.getElementById("player-hp").style.width = `${(playerHP / player.hp) * 100}%`;
            document.getElementById("boss-hp").style.width = `${(bossHP / boss.hp) * 100}%`;
        }

        // 获取题目
        function getQuestion(level) {
            const filteredQuestions = questions.filter(q => q.difficulty <= level);
            return filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
        }

        function renderQuestion() {
            currentQuestion = getQuestion(level); // 固定当前题目
            document.getElementById("question").innerHTML = currentQuestion.question;

            if (currentQuestion.img != ""){
                document.getElementById("question").innerHTML = `${currentQuestion.question}<img src="${currentQuestion.img}">`;
            }

            if (currentQuestion.options.length > 0) {
                // 显示选择题
                document.getElementById("options").style.display = "flex";
                document.getElementById("input-answer").style.display = "none";
                document.getElementById("options").innerHTML = currentQuestion.options
                    .map((option) => `<div class="option" onclick="submitAnswer('${option}')">${option}</div>`)
                    .join("");
            } else {
                // 显示输入框
                document.getElementById("options").style.display = "none";
                document.getElementById("input-answer").disabled = false;
                document.getElementById("input-answer").style.display = "flex";
                document.getElementById("answer-input").value = ""; // 清空输入框
                document.getElementById("answer-input").focus();
            }
        }

        function playCharacterAnimation(characterId, animationClass, actionImg = "") {
            let character = document.getElementById(characterId);
            character.classList.add(animationClass);
            let originImg = character.src
            if (actionImg != ""){
                character.src = actionImg;
            }

            // 动画结束后移除类
            character.addEventListener("animationend", () => {
                character.classList.remove(animationClass);
                character.src = originImg;
            }, { once: true });
        }

        function showParticles(isPlayer) {
            const container = isPlayer ? document.getElementById("boss-image") : document.getElementById("player-image");
            const rect = container.getBoundingClientRect(); // 获取目标图像的位置信息

            const centerX = rect.left + rect.width / 2; // 图像中心的 x 坐标
            // const centerY = rect.top + rect.height / 2; // 图像中心的 y 坐标
            const centerY = rect.top; // 图像中心的 y 坐标

            for (let i = 0; i < 10; i++) {
                const particle = document.createElement("div");
                particle.className = "particle";
                particle.style.setProperty("--dx", Math.random() * 2 - 1);
                particle.style.setProperty("--dy", Math.random() * 2 - 1);
                // 设置粒子初始位置
                particle.style.left = `${centerX}px`;
                particle.style.top = `${centerY}px`;

                container.parentElement.appendChild(particle);
                setTimeout(() => container.parentElement.removeChild(particle), 1000);
            }
        }

        // 创建函数以等待音频播放完成
        async function playAudioAndWait(audioPath, delay = 0) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(audioPath);
                if (delay > 0) {
                    setTimeout(() => {
                        audio.play().then(() => {
                            console.log('Audio started playing');
                            audio.addEventListener('ended', () => {
                                console.log('Audio finished playing');
                                resolve(); // 音频播放完成后继续执行
                            });
                        }).catch((error) => {
                            console.error('Error playing audio:', error);
                            reject(error);
                        });
                    }, delay);
                    return;
                }
                audio.play().then(() => {
                    console.log('Audio started playing');
                    audio.addEventListener('ended', () => {
                        console.log('Audio finished playing');
                        resolve(); // 音频播放完成后继续执行
                    });
                }).catch((error) => {
                    console.error('Error playing audio:', error);
                    reject(error);
                });
            });
        }

        async function showAttackEffect(isPlayer) {
            showParticles(isPlayer);

            // 角色动作动画
            const attackerId = isPlayer ? "player-image" : "boss-image";
            const defenderId = isPlayer ? "boss-image" : "player-image";

            const attackClass = isPlayer ? "attack" : "boss-attack";
            const hurtClass = isPlayer ? "boss-hurt" : "hurt";

            bossIndex = level - 1;
            const boss = bosses[bossIndex];

            const attackerImg = isPlayer ? player.attackerImg : boss.image_attack;

            playCharacterAnimation(attackerId, attackClass, attackerImg); // 攻击动画
            playCharacterAnimation(defenderId, hurtClass, "");  // 受伤动画

            const attackerSound = isPlayer? 'player-attack-sound' : 'boss-attack-sound';
            attackSound = document.getElementById(attackerSound);

            const hurtSoundID = isPlayer ? 'boss-hurt-sound' : 'player-hurt-sound';
            hurtSound = document.getElementById(hurtSoundID);

            // 播放音效
            // attackSound.currentTime = 0; // 每次播放前重置音效进度
            // attackSound.play();
            
            // hurtSound.currentTime = 0; // 每次播放前重置音效进度
            // hurtSound.play();

            playAudioAndWait(attackSound.src);
            await playAudioAndWait(hurtSound.src, 300);
        }

        function showLevelUp() {
            const levelUp = document.getElementById("level-up");
            levelUp.style.display = "block";
            setTimeout(() => (levelUp.style.display = "none"), 2000);
        }

        // 展示技能解锁弹层
        function showSkillUnlock(skill) {
            // 获取弹层元素
            const overlay = document.getElementById('skill-overlay');
            const skillIcon = document.getElementById('skill-icon');
            const skillDescription = document.getElementById('skill-description');

            // 更新技能图标和描述
            skillIcon.src = skill.icon; // 假设技能对象中有图标路径
            skillDescription.textContent = skill.description;

            // 显示弹层
            overlay.style.display = 'flex';

            // 添加点击隐藏逻辑
            overlay.onclick = () => {
                overlay.style.display = 'none';
            };
        }

        function addSkill(skillID) {
            if (!skills[skillID]){
                return
            }
            skill = skills[skillID];
            player.skills[skillID] = {
                name: skill.name,
                value: skill.value
            };
            if (skill.event_listener && skill.event_listener.length > 0){
                skill.event_listener.map((event) => {
                    player[event] = skill[event];
                });
            }
            if (skill.damageFixer) {
                player.damageFixers.push(skill.damageFixer);
            }
            if (skill.defenseFixer) {
                player.defenseFixers.push(skill.defenseFixer);
            }
            showSkillUnlock(skill);
        }

        function onBossDefeated(){
            bossIndex = level - 1;
            const boss = bosses[bossIndex];
            effectToast("获胜！", true);
            if (boss && boss.awards.length > 0){
                boss.awards.map((award, index) => {
                    if (!skills[award]){
                        return
                    }
                    let ri = Math.floor(Math.random()*3) + 1;
                    if (currentLevelWrongCount > ri){
                        return
                    }
                    addSkill(award);
                })
            } 
        }

        // 检查游戏状态
        function checkGameStatus() {
            if (bossHP <= 0) {
                onBossDefeated();
                level++;
                if (level <= bosses.length) {
                    showLevelUp();
                    player.hp = calPlayerHP(level);
                    playerHP = Math.min(playerHP + 20, player.hp);
                    updateBossInfo();
                    renderQuestion(); // 渲染下一题
                    currentLevelWrongCount = 0;
                    return;
                }
                effectToast("恭喜你通关了！", true);
                showSummary();
                return;
            } else if (playerHP <= 0) {
                if (player.on_dead()){
                    effectToast("你输了！", false);
                    showSummary();
                    return;
                }
            }
            renderQuestion(); // 渲染下一题
        }

        function effectToast(message, isPlayer) {
            const effect = document.createElement("div");
            effect.className = isPlayer ? "attack-effect" : "damage-effect";
            effect.innerText = message;
            document.body.appendChild(effect);

            // 动画结束后移除元素
            setTimeout(() => {
                document.body.removeChild(effect);
            }, 1000);
        }

        function calAttackVal(baseVal, attacker, defender){
            let attackVal = baseVal;
            let attackAttr = baseDamageFixer(attacker);
            if (attacker.damageFixers.length > 0){
                attacker.damageFixers.forEach((fixer, index) => {
                    attackAttr = fixer(attacker, attackAttr);
                });
            }
            let defenderAttr = basedefenseFixer(defender);
            if (defender.defenseFixers.length > 0){
                defender.defenseFixers.forEach((fixer, index) => {
                    defenderAttr = fixer(defender, defenderAttr);
                });
            }
            
            attackVal = baseVal * (1 + attackAttr.damage)/100;
            if (attackAttr.crit_rate > 0 && !defender.crit_immunity){
                let ri = Math.floor(Math.random()*100);
                if (ri < attackAttr.crit_rate){
                    attackVal *= (1 + (attackAttr.crit_multiplier/100));
                    attackVal = Math.round(attackVal);
                    effectToast("暴击！", true);
                }
            }

            attackVal -= attackVal * (defenderAttr.damage_reduction/100);
            attackVal = Math.max(Math.round(attackVal), 1);

            return attackVal;
        }

        function submitAnswer(answer) {
            totalAttempts++; // 总答题数 +1
            if (!answer) {
                document.getElementById("input-answer").disabled = true;
                answer = document.getElementById("answer-input").value.trim(); // 获取用户输入
            }
            bossIndex = level - 1;
            const boss = bosses[bossIndex];
            if (answer.toLowerCase() === currentQuestion.answer.toLowerCase()) {
                correctCount++; // 正确数 +1
                attackVal = calAttackVal((currentQuestion.difficulty+1) * 5, player, boss)
                bossHP -= attackVal;
                bossHP = Math.max(bossHP, 0);
                showAttackEffect(true);
            } else {
                currentLevelWrongCount++;
                attackVal = calAttackVal((currentQuestion.difficulty+1) * 5, boss, player)
                playerHP -= attackVal;
                playerHP = Math.max(playerHP, 0);
                showAttackEffect(false);
                // 记录错误题目及知识点
                wrongQuestions.push({
                    question: currentQuestion,
                    userAnswer: answer,
                });
            }
            updateHealthBars();
            checkGameStatus();
        }

        // 闯关总结函数
        function showSummary() {
            document.getElementById("summary-container").style.display = "block";
            document.getElementById("game-container").style.display = "none";
            // 计算正确率
            const accuracy = ((correctCount / totalAttempts) * 100).toFixed(2);

            // 获取页面元素
            const attemptsElement = document.getElementById("attempts");
            const accuracyElement = document.getElementById("accuracy");
            const wrongSection = document.getElementById("wrong-section");
            const wrongList = document.getElementById("wrong-list");

            // 填充统计数据
            attemptsElement.textContent = `累计答题次数: ${totalAttempts}`;
            accuracyElement.textContent = `正确率: ${accuracy}%`;

            // 填充错误题目信息
            if (wrongQuestions.length > 0) {
                wrongSection.style.display = "block";
                wrongList.innerHTML = ""; // 清空列表
                wrongQuestions.forEach((item, index) => {
                    const listItem = document.createElement("li");
                    let qaHtml = `<p><strong>${index + 1}. 题目:</strong> ${item.question.question}`
                    if (item.question.img!= ""){
                        qaHtml += `<img src="${item.question.img}">`;
                    }
                    qaHtml += `</p><p><span class="highlight">你的答案:</span> ${item.userAnswer}</p>
                        <p><strong>正确答案:</strong> ${item.question.answer}</p>
                    `;
                    if (item.question.knowledge!= ""){
                        qaHtml += `<p><em>知识点:</em> ${item.question.knowledge}</p>`;
                    }
                    listItem.innerHTML = qaHtml;
                    wrongList.appendChild(listItem);
                });
            } else {
                // 如果没有错题，隐藏错误区域
                wrongSection.innerHTML = "<p>太棒了！你没有做错任何题目！</p>";
            }
        }

        function sillDo(skillID = ''){
            if (!skills[skillID]) {
                return
            }
            const skill = skills[skillID];
            if (skill.do) {
                skill.do();
            }
        }

        function renderSkills(reset = false){
            const activeSkillContainer = document.getElementById("active-skill-container");
            const passiveSkillContainer = document.getElementById("passive-skill-container");
            passiveSkillHtml = "";
            activeSkillHtml = "";
            for(skillID in player.skills){
                const skill = skills[skillID];
                if (reset){
                    player.skills[skillID].value = skill.value;
                }
                if (player.skills[skillID].value <= 0){
                    return
                }
                if (skill.passive){
                    passiveSkillHtml += `<div class="passive-skill-button" style="background-image: url('${skill.icon}');"></div>`
                }else{
                    activeSkillHtml += `<div onclick="sillDo('${skillID}')" class="active-skill-button" style="background-image: url('${skill.icon}');"></div>`
                }
            }
            activeSkillContainer.innerHTML = activeSkillHtml;
            passiveSkillContainer.innerHTML = passiveSkillHtml;
        }

        function resetGame(setLevel = 1) {
            // 重置关卡
            level = setLevel;

            // 重置玩家血量
            playerHP = calPlayerHP(level);
            player.hp = playerHP
            currentLevelWrongCount = 0;
            document.getElementById("player-name").textContent = player.name;
            document.getElementById("player-image").src = player.image;
            document.getElementById("player-attack-sound").src = player.attack_sound;
            document.getElementById("player-hurt-sound").src = player.hurt_sound;
            renderSkills(true);

            // 重置Boss信息
            updateBossInfo();

            // 切换到游戏界面
            document.getElementById("level-select").style.display = "none";
            document.getElementById("game-container").style.display = "block";

            // 显示游戏开始的提示或初始化界面
            effectToast("游戏开始！", false);
            renderQuestion();
        }

        // 按钮事件绑定
        document.getElementById("return-button").addEventListener("click", renderLevelSelect);

        // 初始化
        resetGame(1);

        // 初始化游戏时显示关卡选择
        renderLevelSelect();
    </script>
</body>
</html>
